<!DOCTYPE html>
<html lang="en">
<head>
  <title>Teacher Portal</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <style>
    /* --- THEME VARIABLES --- */
    :root { --primary: #2563eb; --primary-dark: #1e40af; --secondary: #64748b; --success: #10b981; --danger: #ef4444; --warning: #f59e0b; --bg: #f1f5f9; --card: #ffffff; --text-main: #1e293b; --text-muted: #64748b; --border: #e2e8f0; --radius: 12px; --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
    
    body { font-family: 'Inter', sans-serif; background-color: var(--bg); margin: 0; padding: 20px 10px; color: var(--text-main); line-height: 1.5; }
    
    .container { max-width: 600px; margin: 0 auto; background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow); overflow: hidden; position: relative; }
    
    /* --- HEADER (Fixed Overlap) --- */
    .header { 
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); 
      /* Added padding-top to give space for the button */
      padding: 50px 20px 25px 20px; 
      text-align: center; 
      color: white; 
      position: relative; 
    }
    .header h2 { margin: 0; font-size: 1.5rem; font-weight: 700; }
    
    /* QUEUE BUTTON (Positioned Top Right) */
    .queue-btn {
      position: absolute; top: 15px; right: 15px;
      background: rgba(255, 255, 255, 0.2); border: 1px solid rgba(255, 255, 255, 0.4);
      color: white; padding: 6px 10px; border-radius: 8px; cursor: pointer;
      font-size: 0.85rem; font-weight: 600; display: flex; align-items: center; gap: 6px;
      transition: 0.2s; z-index: 10;
    }
    .queue-btn:hover { background: rgba(255, 255, 255, 0.3); }
    .queue-badge { 
      background: var(--warning); color: #fff; font-size: 0.75rem; 
      padding: 2px 6px; border-radius: 10px; display: none; 
    }

    form { padding: 25px; }
    #data-status { text-align: center; font-size: 0.85rem; margin-bottom: 20px; font-weight: 600; }
    
    .form-group { margin-bottom: 20px; }
    label.field-label { display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-main); font-size: 0.9rem; }
    
    input[type="text"], textarea { width: 100%; padding: 12px 15px; border: 1px solid var(--border); border-radius: 8px; font-size: 16px; background: #f8fafc; box-sizing: border-box; }
    
    .branch-group { display: flex; background: #f1f5f9; padding: 4px; border-radius: 8px; }
    .branch-group label { flex: 1; text-align: center; padding: 10px; cursor: pointer; font-size: 0.9rem; font-weight: 500; color: var(--text-muted); border-radius: 6px; }
    .branch-group input { display: none; }
    .branch-group label:has(input:checked) { background: white; color: var(--primary); font-weight: 700; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    
    #classCheckboxes { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
    .class-option { display: flex; align-items: center; justify-content: center; padding: 12px 5px; background: white; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; font-weight: 600; color: var(--text-muted); font-size: 0.9rem; }
    .class-option:has(input:checked) { background: var(--primary); color: white; border-color: var(--primary); }
    .class-option input { display: none; }
    
    .bulk-actions { display: flex; gap: 10px; margin-bottom: 12px; }
    .bulk-btn { flex: 1; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 6px; border: 1px solid transparent; }
    .bulk-btn.present { background: #ecfdf5; color: #059669; border-color: #d1fae5; }
    .bulk-btn.absent { background: #fef2f2; color: #dc2626; border-color: #fee2e2; }
    
    #studentListContainer { max-height: 40vh; overflow-y: auto; border: 1px solid var(--border); background: white; border-radius: 8px; display: none; }
    .class-header { background: #f1f5f9; padding: 10px 15px; position: sticky; top: 0; border-bottom: 1px solid var(--border); font-size: 0.85rem; font-weight: 700; color: var(--text-muted); }
    .student-item { padding: 12px 15px; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; }
    .student-item label { margin: 0; font-weight: 500; display: flex; align-items: center; gap: 12px; width: 100%; cursor: pointer; color: var(--text-main); }
    input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--primary); }
    
    .lock-section { background-color: #fffbeb; border: 1px solid #fcd34d; color: #92400e; padding: 15px; border-radius: 8px; margin-top: 10px; display: flex; align-items: center; gap: 12px; cursor: pointer; }
    .lock-section input { width: 20px; height: 20px; accent-color: #d97706; }
    
    button { width: 100%; padding: 16px; border: none; border-radius: 10px; font-size: 1rem; font-weight: 700; cursor: pointer; margin-top: 20px; display: flex; align-items: center; justify-content: center; gap: 8px; }
    #submitBtn { background: var(--primary); color: white; box-shadow: 0 4px 6px rgba(37, 99, 235, 0.2); }
    #submitBtn:disabled { background: #cbd5e1; box-shadow: none; cursor: not-allowed; }
    
    #postSubmitActions { display: none; gap: 10px; margin-top: 20px; }
    .btn-new { background: white; color: var(--primary); border: 2px solid var(--primary); }
    .btn-update { background: var(--warning); color: white; }
    
    .loading { display: none; text-align: center; margin-top: 15px; color: var(--text-muted); }
    
    /* --- MODAL STYLES --- */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.4); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
    .modal-box { background: white; padding: 30px; border-radius: 16px; text-align: center; width: 85%; max-width: 350px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); max-height: 80vh; overflow-y: auto; }
    
    /* Queue List Styles */
    .queue-list { list-style: none; padding: 0; margin: 0; text-align: left; }
    .queue-item { background: #f8fafc; border: 1px solid var(--border); padding: 12px; border-radius: 8px; margin-bottom: 10px; cursor: pointer; transition: 0.2s; }
    .queue-item:hover { border-color: var(--primary); background: #f0f9ff; }
    .q-title { font-weight: 700; color: var(--text-main); font-size: 0.95rem; }
    .q-meta { font-size: 0.8rem; color: var(--text-muted); margin-top: 4px; }
    .q-empty { text-align: center; color: var(--text-muted); padding: 20px; }
    .close-modal-btn { background: #e2e8f0; color: var(--text-main); margin-top: 15px; width: 100%; padding: 10px; font-size: 0.9rem; }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <h2>üì¢ Teacher Portal</h2>
    <p>Emergency / Attendance System</p>
    
    <div class="queue-btn" onclick="openQueueModal()">
      <span>üìÇ Active</span>
      <span class="queue-badge" id="queueCount">0</span>
    </div>
  </div>

  <form id="mainForm">
    <div id="data-status" style="color: var(--text-muted);">‚è≥ Connecting to database...</div>
    
    <div class="form-group">
      <label class="field-label">Teacher Name</label>
      <input type="text" id="teacherName" placeholder="e.g. Mr. Roy" required>
    </div>

    <div class="form-group">
      <label class="field-label">Subject</label>
      <input type="text" id="subject" placeholder="e.g. Mathematics" required>
    </div>

    <div class="form-group">
      <label class="field-label">Branch</label>
      <div class="branch-group">
        <label><input type="radio" name="branch" value="Science" required> Science</label>
        <label><input type="radio" name="branch" value="Commerce"> Commerce</label>
        <label><input type="radio" name="branch" value="Arts"> Arts</label>
      </div>
    </div>

    <div class="form-group">
      <label class="field-label">Select Class</label>
      <div id="classCheckboxes"></div>
    </div>

    <div class="form-group">
      <label class="field-label">Student List</label>
      <div class="bulk-actions" id="bulkActions" style="display:none;">
        <div class="bulk-btn present" onclick="toggleAll(true)"><span>‚úÖ</span> Present All</div>
        <div class="bulk-btn absent" onclick="toggleAll(false)"><span>‚ùå</span> Absent All</div>
      </div>
      <div id="studentListContainer">
        <div style="padding: 30px; color:#94a3b8; text-align:center;">Select a class above.</div>
      </div>
    </div>

    <div class="form-group">
      <label class="field-label">Note / Description (Optional)</label>
      <textarea id="description" rows="3" placeholder="Any remarks..."></textarea>
    </div>

    <label class="lock-section">
      <input type="checkbox" id="closeClass">
      <div class="lock-text">
        <strong>Close & Lock Class</strong>
        <small>Mark finished. Stops future edits.</small>
      </div>
    </label>

    <button type="submit" id="submitBtn" disabled>Submit Attendance üöÄ</button>
    <p class="loading" id="loader">Syncing with Google Sheets...</p>

    <div id="postSubmitActions">
      <button type="button" class="btn-new" onclick="startNew()">‚ûï New Class</button>
      <button type="button" class="btn-update" onclick="continueUpdate()">‚úèÔ∏è Add Late Student</button>
    </div>
  </form>
</div>

<div id="statusModal" class="modal-overlay">
  <div class="modal-box">
    <div style="font-size: 40px; margin-bottom: 10px;" id="modalIcon">‚úÖ</div>
    <div style="font-size: 1.2rem; font-weight: 700;" id="modalText">Saved!</div>
  </div>
</div>

<div id="queueModal" class="modal-overlay">
  <div class="modal-box">
    <h3 style="margin-top:0;">üìÇ Active Classes</h3>
    <p style="font-size:0.85rem; color:#666;">Click to resume & close a class.</p>
    <ul class="queue-list" id="queueList">
      </ul>
    <button class="close-modal-btn" onclick="document.getElementById('queueModal').style.display='none'">Close</button>
  </div>
</div>

<script>
  // --- CONFIGURATION ---
  const scriptURL = 'https://script.google.com/macros/s/AKfycbw4jkxL4EXMGKrbmL8gnRGW4RSgjTYg4Smw6Ec2mv_AUOBwb-yqXWl8EKJq_Avhm6o9wA/exec'; 

  let allStudents = []; 
  let currentSessionID = null; // Tracks unique ID of current editing session

  // --- LOCAL STORAGE MANAGER ---
  const LS_KEY = "teacherPortal_queue";

  function getQueue() {
    return JSON.parse(localStorage.getItem(LS_KEY) || "[]");
  }

  function saveToQueue(payload) {
    let queue = getQueue();
    // Unique ID based on Teacher + Subject + Class (to mimic backend logic)
    if (!currentSessionID) {
      currentSessionID = Date.now().toString(); // Generate new ID
    }
    
    // Check if session exists, update it
    const index = queue.findIndex(q => q.id === currentSessionID);
    
    const sessionData = {
      id: currentSessionID,
      payload: payload,
      timestamp: new Date().toLocaleString()
    };

    if (index > -1) {
      queue[index] = sessionData;
    } else {
      queue.push(sessionData);
    }
    
    localStorage.setItem(LS_KEY, JSON.stringify(queue));
    updateQueueUI();
  }

  function removeFromQueue(id) {
    let queue = getQueue();
    queue = queue.filter(q => q.id !== id);
    localStorage.setItem(LS_KEY, JSON.stringify(queue));
    updateQueueUI();
    currentSessionID = null; 
  }

  function updateQueueUI() {
    const queue = getQueue();
    const countEl = document.getElementById('queueCount');
    countEl.innerText = queue.length;
    countEl.style.display = queue.length > 0 ? 'inline-block' : 'none';
  }

  // --- QUEUE MODAL LOGIC ---
  function openQueueModal() {
    const queue = getQueue();
    const listEl = document.getElementById('queueList');
    listEl.innerHTML = "";

    if (queue.length === 0) {
      listEl.innerHTML = "<li class='q-empty'>No unended active classes.</li>";
    } else {
      queue.forEach(item => {
        const p = item.payload;
        let className = "Unknown Class";
        if(p.students.length > 0) className = "Class " + p.students[0].classVal;

        const li = document.createElement('li');
        li.className = 'queue-item';
        li.innerHTML = `
          <div class="q-title">${p.teacher} - ${p.subject}</div>
          <div class="q-meta">${className} ‚Ä¢ ${item.timestamp}</div>
        `;
        li.onclick = () => loadSessionFromQueue(item);
        listEl.appendChild(li);
      });
    }
    document.getElementById('queueModal').style.display = 'flex';
  }

  function loadSessionFromQueue(session) {
    // 1. Restore Data
    const p = session.payload;
    document.getElementById('teacherName').value = p.teacher;
    document.getElementById('subject').value = p.subject;
    document.getElementById('description').value = p.description;
    
    // Restore Branch
    const branchRad = document.querySelector(`input[name="branch"][value="${p.branch}"]`);
    if(branchRad) branchRad.checked = true;

    // Restore Class Selection
    if (p.students.length > 0) {
        const clsVal = p.students[0].classVal;
        const clsRad = document.querySelector(`.class-selector[value="${clsVal}"]`);
        if(clsRad) {
            clsRad.checked = true;
            updateStudentList(); // Trigger list render
        }

        // Restore Student Checkboxes
        setTimeout(() => {
            const studentNames = p.students.map(s => s.name);
            document.querySelectorAll('.student-checkbox').forEach(box => {
                if (studentNames.includes(box.value)) {
                    box.checked = true;
                }
            });
            // Show submit button, hide actions BUT DO NOT CLEAR CHECKBOXES
            continueUpdate(false); 
        }, 100);
    }

    currentSessionID = session.id;
    document.getElementById('queueModal').style.display = 'none';
  }

  // --- INITIALIZATION ---
  window.addEventListener('load', () => {
    updateQueueUI(); 
    fetch(scriptURL)
      .then(response => response.json())
      .then(data => {
        allStudents = data; 
        document.getElementById('data-status').innerHTML = "‚úÖ Database Connected";
        document.getElementById('data-status').style.color = "var(--success)";
        document.getElementById('submitBtn').disabled = false;
        generateClassCheckboxes(); 
      })
      .catch(error => {
        document.getElementById('data-status').innerHTML = "‚ùå Connection Failed.";
        document.getElementById('data-status').style.color = "var(--danger)";
      });
  });

  const classContainer = document.getElementById('classCheckboxes');
  function generateClassCheckboxes() {
    classContainer.innerHTML = "";
    for (let i = 5; i <= 12; i++) {
      let label = document.createElement('label');
      label.className = "class-option"; 
      label.innerHTML = `<input type="radio" name="classGroup" class="class-selector" value="${i}"> Class ${i}`;
      classContainer.appendChild(label);
    }
    attachClassListeners();
  }

  const studentContainer = document.getElementById('studentListContainer');
  const bulkActions = document.getElementById('bulkActions');

  function attachClassListeners() {
    document.querySelectorAll('.class-selector').forEach(chk => {
      chk.addEventListener('change', updateStudentList);
    });
  }

  function updateStudentList() {
    studentContainer.style.display = 'block';
    studentContainer.innerHTML = ''; 
    let anyChecked = false;
    const selectedRadio = document.querySelector('.class-selector:checked');
    
    if (selectedRadio) {
      anyChecked = true;
      let selectedClass = selectedRadio.value; 
      let filteredStudents = allStudents.filter(s => s.classVal.includes(selectedClass));
        if(filteredStudents.length > 0) {
          let header = document.createElement('div');
          header.className = 'class-header';
          header.innerText = `Class ${selectedClass}`;
          studentContainer.appendChild(header);
          filteredStudents.forEach(std => {
            let div = document.createElement('div');
            div.className = 'student-item';
            div.innerHTML = `<label><input type="checkbox" class="student-checkbox" value="${std.name}" data-phone="${std.phone}" data-class="${selectedClass}"> ${std.name}</label>`;
            studentContainer.appendChild(div);
          });
      }
    }

    if (anyChecked) {
      bulkActions.style.display = "flex"; 
    } else {
      bulkActions.style.display = "none";
      studentContainer.innerHTML = '<div style="padding: 30px; color:#94a3b8; text-align:center;">Select a class above.</div>';
    }
  }

  function toggleAll(status) {
    document.querySelectorAll('.student-checkbox').forEach(box => { box.checked = status; });
  }

  // --- SUBMIT LOGIC ---
  const form = document.getElementById('mainForm');
  const loader = document.getElementById('loader');
  const modal = document.getElementById('statusModal');
  const modalIcon = document.getElementById('modalIcon');
  const modalText = document.getElementById('modalText');
  const submitBtn = document.getElementById('submitBtn');
  const actionBtns = document.getElementById('postSubmitActions');

  form.addEventListener('submit', e => {
    e.preventDefault();
    loader.style.display = 'block';
    submitBtn.style.display = 'none';

    let selectedStudents = [];
    document.querySelectorAll('.student-checkbox:checked').forEach(box => {
      selectedStudents.push({ name: box.value, phone: box.getAttribute('data-phone'), classVal: box.getAttribute('data-class') });
    });

    if (selectedStudents.length === 0) {
       let selectedRadio = document.querySelector('.class-selector:checked');
       if (!selectedRadio) {
         alert("Please select a Class.");
         loader.style.display = 'none';
         submitBtn.style.display = 'block';
         return;
       }
       selectedStudents.push({ name: "(None/Absent)", phone: "", classVal: selectedRadio.value });
    }

    let isCloseRequested = document.getElementById('closeClass').checked;

    let payload = {
      teacher: document.getElementById('teacherName').value,
      subject: document.getElementById('subject').value,
      branch: document.querySelector('input[name="branch"]:checked').value,
      description: document.getElementById('description').value,
      students: selectedStudents,
      close: isCloseRequested
    };

    fetch(scriptURL, {
      method: 'POST',
      body: JSON.stringify(payload)
    })
    .then(response => response.text()) 
    .then(text => {
      loader.style.display = 'none';
      
      if (text.includes("Error:")) {
        alert(text);
        submitBtn.style.display = 'flex'; 
        return;
      }

      if (text.includes("Success")) {
        // --- LOCAL STORAGE LOGIC ---
        if (isCloseRequested) {
          if (currentSessionID) removeFromQueue(currentSessionID);
        } else {
          saveToQueue(payload);
        }
        
        modalIcon.innerHTML = "‚úÖ";
        modalText.innerText = isCloseRequested ? "Saved & Locked!" : "Saved & Active!";
        modal.style.display = 'flex';
        setTimeout(() => {
          modal.style.display = 'none';
          if (!isCloseRequested) {
             actionBtns.style.display = 'flex';
          } else {
             startNew();
          }
        }, 1500);

      } else if (text.includes("CLOSED")) {
        if(currentSessionID) removeFromQueue(currentSessionID);
        modalIcon.innerHTML = "üîí";
        modalText.innerText = "Class is Locked";
        modal.style.display = 'flex';
        setTimeout(() => {
          modal.style.display = 'none';
          submitBtn.style.display = 'flex';
        }, 2000);
      } else {
        alert("Server Error: " + text);
        submitBtn.style.display = 'flex';
      }
    })
    .catch(err => {
      console.error(err);
      alert("Network Error.");
      loader.style.display = 'none';
      submitBtn.style.display = 'flex';
    });
  });

  function startNew() {
     if (currentSessionID) {
         currentSessionID = null; 
         location.reload(); 
     } else {
         location.reload();
     }
  }
  
  // FIXED: Added parameter to decide whether to clear checkboxes or not
  function continueUpdate(clearBoxes = true) { 
    actionBtns.style.display = 'none'; 
    submitBtn.style.display = 'flex'; 
    
    // Only uncheck if explicitly asked (Default behavior for post-submit)
    // When loading from Queue, we pass false to keep them checked.
    if(clearBoxes) {
        document.querySelectorAll('.student-checkbox').forEach(box => { 
            box.checked = false; 
        });
    }
  }
</script>
</body>
</html>
