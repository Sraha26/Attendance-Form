<!DOCTYPE html>
<html lang="en">
<head>
  <title>Teacher Portal</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <style>
    /* --- CSS STYLES --- */
    :root { --primary: #2563eb; --primary-dark: #1e40af; --secondary: #64748b; --success: #10b981; --danger: #ef4444; --warning: #f59e0b; --bg: #f1f5f9; --card: #ffffff; --text-main: #1e293b; --text-muted: #64748b; --border: #e2e8f0; --radius: 12px; --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
    body { font-family: 'Inter', sans-serif; background-color: var(--bg); margin: 0; padding: 20px 10px; color: var(--text-main); line-height: 1.5; }
    .container { max-width: 600px; margin: 0 auto; background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow); overflow: hidden; position: relative; }
    
    .header { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); padding: 50px 20px 25px 20px; text-align: center; color: white; position: relative; }
    .header h2 { margin: 0; font-size: 1.5rem; font-weight: 700; }
    
    .queue-btn { position: absolute; top: 15px; right: 15px; background: rgba(255, 255, 255, 0.2); border: 1px solid rgba(255, 255, 255, 0.4); color: white; padding: 6px 10px; border-radius: 8px; cursor: pointer; font-size: 0.85rem; font-weight: 600; display: flex; align-items: center; gap: 6px; transition: 0.2s; z-index: 10; }
    .queue-btn:hover { background: rgba(255, 255, 255, 0.3); }
    .queue-badge { background: var(--warning); color: #fff; font-size: 0.75rem; padding: 2px 6px; border-radius: 10px; display: none; }
    
    form { padding: 25px; }
    #data-status { text-align: center; font-size: 0.85rem; margin-bottom: 20px; font-weight: 600; }
    .form-group { margin-bottom: 20px; }
    label.field-label { display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-main); font-size: 0.9rem; }
    input[type="text"], textarea { width: 100%; padding: 12px 15px; border: 1px solid var(--border); border-radius: 8px; font-size: 16px; background: #f8fafc; box-sizing: border-box; }
    
    /* VERTICAL BRANCH BUTTONS */
    .branch-group { display: flex; flex-direction: column; gap: 10px; background: #f1f5f9; padding: 10px; border-radius: 8px; }
    .branch-group label { width: 100%; text-align: center; padding: 14px; cursor: pointer; font-size: 0.95rem; font-weight: 600; color: var(--text-muted); background: white; border: 1px solid var(--border); border-radius: 8px; transition: all 0.2s; box-sizing: border-box; }
    .branch-group input { display: none; }
    .branch-group label:has(input:checked) { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 6px rgba(37, 99, 235, 0.2); }
    
    /* CLASS GRID */
    #classCheckboxes { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
    .class-option { display: flex; align-items: center; justify-content: center; padding: 12px 5px; background: white; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; font-weight: 600; color: var(--text-muted); font-size: 0.9rem; }
    .class-option:has(input:checked) { background: var(--primary); color: white; border-color: var(--primary); }
    .class-option input { display: none; }
    
    .bulk-actions { display: flex; gap: 10px; margin-bottom: 12px; }
    .bulk-btn { flex: 1; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 6px; border: 1px solid transparent; }
    .bulk-btn.present { background: #ecfdf5; color: #059669; border-color: #d1fae5; }
    .bulk-btn.absent { background: #fef2f2; color: #dc2626; border-color: #fee2e2; }
    
    #studentListContainer { max-height: 40vh; overflow-y: auto; border: 1px solid var(--border); background: white; border-radius: 8px; display: none; }
    .class-header { background: #f1f5f9; padding: 10px 15px; position: sticky; top: 0; border-bottom: 1px solid var(--border); font-size: 0.85rem; font-weight: 700; color: var(--text-muted); }
    .student-item { padding: 12px 15px; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; }
    .student-item label { margin: 0; font-weight: 500; display: flex; align-items: center; gap: 12px; width: 100%; cursor: pointer; color: var(--text-main); }
    input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--primary); }
    
    .lock-section { background-color: #fffbeb; border: 1px solid #fcd34d; color: #92400e; padding: 15px; border-radius: 8px; margin-top: 10px; display: flex; align-items: center; gap: 12px; cursor: pointer; }
    .lock-section input { width: 20px; height: 20px; accent-color: #d97706; }
    
    button { width: 100%; padding: 16px; border: none; border-radius: 10px; font-size: 1rem; font-weight: 700; cursor: pointer; margin-top: 20px; display: flex; align-items: center; justify-content: center; gap: 8px; }
    #submitBtn { background: var(--primary); color: white; box-shadow: 0 4px 6px rgba(37, 99, 235, 0.2); }
    #submitBtn:disabled { background: #cbd5e1; box-shadow: none; cursor: not-allowed; }
    
    /* Post-Submit Action Buttons */
    #postSubmitActions { display: none; gap: 10px; margin-top: 20px; }
    .btn-new { background: white; color: var(--primary); border: 2px solid var(--primary); }
    .btn-update { background: var(--warning); color: white; }
    
    .loading { display: none; text-align: center; margin-top: 15px; color: var(--text-muted); }
    
    #debugBox { font-size: 0.75rem; background: #eee; padding: 10px; margin-top: 20px; border-radius: 8px; color: #333; display: none; }

    /* MODALS */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.4); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
    .modal-box { background: white; padding: 30px; border-radius: 16px; text-align: center; width: 85%; max-width: 350px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); max-height: 80vh; overflow-y: auto; }
    .queue-list { list-style: none; padding: 0; margin: 0; text-align: left; }
    .queue-item { background: #f8fafc; border: 1px solid var(--border); padding: 12px; border-radius: 8px; margin-bottom: 10px; cursor: pointer; transition: 0.2s; }
    .queue-item:hover { border-color: var(--primary); background: #f0f9ff; }
    .q-title { font-weight: 700; color: var(--text-main); font-size: 0.95rem; }
    .q-meta { font-size: 0.8rem; color: var(--text-muted); margin-top: 4px; }
    .q-empty { text-align: center; color: var(--text-muted); padding: 20px; }
    .close-modal-btn { background: #e2e8f0; color: var(--text-main); margin-top: 15px; width: 100%; padding: 10px; font-size: 0.9rem; }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <h2>üì¢ Teacher Portal</h2>
    <p>Emergency / Attendance System</p>
    <div class="queue-btn" onclick="openQueueModal()">
      <span>üìÇ Active</span>
      <span class="queue-badge" id="queueCount">0</span>
    </div>
  </div>

  <form id="mainForm">
    <div id="data-status" style="color: var(--text-muted);">‚è≥ Connecting to database...</div>
    
    <div class="form-group">
      <label class="field-label">Teacher Name</label>
      <input type="text" id="teacherName" placeholder="e.g. Mr. Roy" required>
    </div>

    <div class="form-group">
      <label class="field-label">Subject</label>
      <input type="text" id="subject" placeholder="e.g. Mathematics" required>
    </div>

    <div class="form-group">
      <label class="field-label">Branch</label>
      <div class="branch-group" id="branchContainer">
        <div style="padding:10px; width:100%; text-align:center; color:#ccc;">Loading branches...</div>
      </div>
    </div>

    <div class="form-group">
      <label class="field-label">Select Class</label>
      <div id="classCheckboxes"></div>
    </div>

    <div class="form-group">
      <label class="field-label">Student List</label>
      <div class="bulk-actions" id="bulkActions" style="display:none;">
        <div class="bulk-btn present" onclick="toggleAll(true)"><span>‚úÖ</span> Present All</div>
        <div class="bulk-btn absent" onclick="toggleAll(false)"><span>‚ùå</span> Absent All</div>
      </div>
      <div id="studentListContainer">
        <div style="padding: 30px; color:#94a3b8; text-align:center;">Select Branch and Class above.</div>
      </div>
    </div>

    <div class="form-group">
      <label class="field-label">Note / Description (Optional)</label>
      <textarea id="description" rows="3" placeholder="Any remarks..."></textarea>
    </div>

    <label class="lock-section">
      <input type="checkbox" id="closeClass">
      <div class="lock-text">
        <strong>Close & Lock Class</strong>
        <small>Mark finished. Stops future edits.</small>
      </div>
    </label>

    <button type="submit" id="submitBtn" disabled>Submit Attendance üöÄ</button>
    <p class="loading" id="loader">Syncing with Google Sheets...</p>

    <div id="debugBox"></div>

    <div id="postSubmitActions">
      <button type="button" class="btn-update" id="addLateBtn" onclick="handleAddLate()">‚úèÔ∏è Add Late Student</button>
      <button type="button" class="btn-new" onclick="startNew()">‚ûï New Class</button>
    </div>
  </form>
</div>

<div id="statusModal" class="modal-overlay">
  <div class="modal-box">
    <div style="font-size: 40px; margin-bottom: 10px;" id="modalIcon">‚úÖ</div>
    <div style="font-size: 1.2rem; font-weight: 700;" id="modalText">Saved!</div>
  </div>
</div>

<div id="queueModal" class="modal-overlay">
  <div class="modal-box">
    <h3 style="margin-top:0;">üìÇ Active Classes</h3>
    <p style="font-size:0.85rem; color:#666;">Click to resume & close a class.</p>
    <ul class="queue-list" id="queueList"></ul>
    <button class="close-modal-btn" onclick="document.getElementById('queueModal').style.display='none'">Close</button>
  </div>
</div>

<script>
  // --- CONFIGURATION ---
  const scriptURL = 'https://script.google.com/macros/s/AKfycbw1DEvwlEYBhK0BgxEY5fr1ET3GxzVxjU8a81Wfgus7GeMl98TucvuXoodVNuDtfeN6eA/exec'; 

  let allStudents = []; 
  let currentSessionID = null; 

  const LS_KEY = "teacherPortal_queue";
  function getQueue() { return JSON.parse(localStorage.getItem(LS_KEY) || "[]"); }

  // --- DYNAMIC BUTTON TEXT LOGIC ---
  const closeCheckbox = document.getElementById('closeClass');
  const submitBtn = document.getElementById('submitBtn');
  const addLateBtn = document.getElementById('addLateBtn');

  // CHANGE 1: Toggle Button Text based on Checkbox
  closeCheckbox.addEventListener('change', function() {
      if (this.checked) {
          // If checkbox is ticked, change submit button text
          submitBtn.innerHTML = "End Class üèÅ";
          submitBtn.style.backgroundColor = "#d97706"; // Orange/Warning
          
          // Also change the "Add Late Student" button text if visible
          addLateBtn.innerHTML = "End Class üèÅ";
          addLateBtn.style.backgroundColor = "#d97706";
      } else {
          // Reset to default
          submitBtn.innerHTML = "Submit Attendance üöÄ";
          submitBtn.style.backgroundColor = ""; 
          
          addLateBtn.innerHTML = "‚úèÔ∏è Add Late Student";
          addLateBtn.style.backgroundColor = ""; // Reset to default warning color defined in CSS
      }
  });

  // --- QUEUE LOGIC ---
  function saveToQueue(payload) {
    let queue = getQueue();
    if (!currentSessionID) currentSessionID = Date.now().toString(); 
    const index = queue.findIndex(q => q.id === currentSessionID);
    const sessionData = { id: currentSessionID, payload: payload, timestamp: new Date().toLocaleString() };
    if (index > -1) queue[index] = sessionData;
    else queue.push(sessionData);
    localStorage.setItem(LS_KEY, JSON.stringify(queue));
    updateQueueUI();
  }

  function removeFromQueue(id) {
    let queue = getQueue();
    queue = queue.filter(q => q.id !== id);
    localStorage.setItem(LS_KEY, JSON.stringify(queue));
    updateQueueUI();
    currentSessionID = null; 
  }

  function updateQueueUI() {
    const queue = getQueue();
    const countEl = document.getElementById('queueCount');
    countEl.innerText = queue.length;
    countEl.style.display = queue.length > 0 ? 'inline-block' : 'none';
  }

  function openQueueModal() {
    const queue = getQueue();
    const listEl = document.getElementById('queueList');
    listEl.innerHTML = "";
    if (queue.length === 0) listEl.innerHTML = "<li class='q-empty'>No unended active classes.</li>";
    else {
      queue.forEach(item => {
        const p = item.payload;
        let className = p.students.length > 0 ? p.students[0].classVal : "Unknown";
        const li = document.createElement('li');
        li.className = 'queue-item';
        li.innerHTML = `<div class="q-title">${p.teacher} - ${p.subject}</div><div class="q-meta">${className} ‚Ä¢ ${p.branch} ‚Ä¢ ${item.timestamp}</div>`;
        li.onclick = () => loadSessionFromQueue(item);
        listEl.appendChild(li);
      });
    }
    document.getElementById('queueModal').style.display = 'flex';
  }

  function loadSessionFromQueue(session) {
    if(allStudents.length === 0) {
        alert("The student database is still loading... please wait 5 seconds and try again.");
        return;
    }

    const p = session.payload;
    document.getElementById('teacherName').value = p.teacher;
    document.getElementById('subject').value = p.subject;
    document.getElementById('description').value = p.description;
    
    // Select Branch
    const branchRad = document.querySelector(`input[name="branch"][value="${p.branch}"]`);
    if(branchRad) branchRad.checked = true;

    // Select Class & Force Update
    let savedClass = "";
    if (p.students.length > 0) {
        savedClass = p.students[0].classVal; 
    }

    if (savedClass) {
        const clsRad = document.querySelector(`.class-selector[value="${savedClass}"]`);
        if(clsRad) {
            clsRad.checked = true;
            updateStudentList();
            
            const studentNames = p.students.map(s => s.name);
            document.querySelectorAll('.student-checkbox').forEach(box => {
                if (studentNames.includes(box.value)) {
                    box.checked = true;
                }
            });
        }
    }

    currentSessionID = session.id;
    document.getElementById('queueModal').style.display = 'none';
    
    // Show post-submit actions immediately since it's an active class
    document.getElementById('submitBtn').style.display = 'none';
    document.getElementById('postSubmitActions').style.display = 'flex';
  }

  // --- INITIALIZATION ---
  window.addEventListener('load', () => {
    updateQueueUI(); 
    fetch(scriptURL)
      .then(response => response.json())
      .then(data => {
        if(data.error) {
             alert(data.error);
             document.getElementById('branchContainer').innerHTML = `<div style="color:red; padding:10px;">${data.error}</div>`;
             return;
        }

        if (data.students && data.branches) {
          allStudents = data.students;
          renderBranches(data.branches);
        } else {
          alert("Received unexpected data format.");
        }
        document.getElementById('data-status').innerHTML = "‚úÖ Database Connected";
        document.getElementById('data-status').style.color = "var(--success)";
        document.getElementById('submitBtn').disabled = false;
        generateClassCheckboxes(); 
      })
      .catch(error => {
        console.error(error);
        document.getElementById('data-status').innerHTML = "‚ùå Connection Failed.";
        document.getElementById('data-status').style.color = "var(--danger)";
      });
  });

  function renderBranches(branchList) {
    const container = document.getElementById('branchContainer');
    container.innerHTML = ''; 
    branchList.sort();
    branchList.forEach(branchName => {
        const label = document.createElement('label');
        label.innerHTML = `<input type="radio" name="branch" class="branch-selector" value="${branchName}" required> ${branchName}`;
        container.appendChild(label);
    });
    document.querySelectorAll('.branch-selector').forEach(b => {
        b.addEventListener('change', updateStudentList);
    });
  }

  function generateClassCheckboxes() {
    const classContainer = document.getElementById('classCheckboxes');
    classContainer.innerHTML = "";
    for (let i = 5; i <= 12; i++) {
      let label = document.createElement('label');
      label.className = "class-option"; 
      label.innerHTML = `<input type="radio" name="classGroup" class="class-selector" value="Class ${i}"> Class ${i}`;
      classContainer.appendChild(label);
    }
    document.querySelectorAll('.class-selector').forEach(chk => {
      chk.addEventListener('change', updateStudentList);
    });
  }

  function updateStudentList() {
    const studentContainer = document.getElementById('studentListContainer');
    const bulkActions = document.getElementById('bulkActions');
    const debugBox = document.getElementById('debugBox');
    
    studentContainer.style.display = 'block';
    studentContainer.innerHTML = ''; 
    debugBox.style.display = 'none'; 
    
    const selectedClassRadio = document.querySelector('.class-selector:checked');
    const selectedBranchRadio = document.querySelector('.branch-selector:checked');

    if (selectedClassRadio && selectedBranchRadio) {
      
      const selClass = selectedClassRadio.value.toString().trim().toLowerCase(); 
      const selBranch = selectedBranchRadio.value.toString().trim().toLowerCase();

      let filteredStudents = allStudents.filter(s => {
          let sClass = s.classVal.toString().trim().toLowerCase();
          let sBranch = s.branchVal.toString().trim().toLowerCase();
          return sClass == selClass && sBranch == selBranch;
      });

      if(filteredStudents.length > 0) {
          let header = document.createElement('div');
          header.className = 'class-header';
          header.innerText = `${selectedBranchRadio.value} - ${selectedClassRadio.value}`;
          studentContainer.appendChild(header);

          filteredStudents.forEach(std => {
            let div = document.createElement('div');
            div.className = 'student-item';
            div.innerHTML = `<label><input type="checkbox" class="student-checkbox" value="${std.name}" data-phone="${std.phone}" data-class="${std.classVal}"> ${std.name}</label>`;
            studentContainer.appendChild(div);
          });
          bulkActions.style.display = "flex"; 
      } else {
         studentContainer.innerHTML = `<div style="padding: 30px; color:#94a3b8; text-align:center;">
           No students found.<br>
           <small>(Checked: ${selectedClassRadio.value}, ${selectedBranchRadio.value})</small>
         </div>`;
         bulkActions.style.display = "none";
         
         if(allStudents.length > 0) {
            debugBox.style.display = 'block';
            let sample = allStudents.slice(0, 3).map(s => `${s.name} [${s.branchVal}, ${s.classVal}]`).join("<br>");
            debugBox.innerHTML = `<strong>DEBUG (First 3 students):</strong><br>${sample}`;
         }
      }
    } else {
      bulkActions.style.display = "none";
      studentContainer.innerHTML = '<div style="padding: 30px; color:#94a3b8; text-align:center;">Please select <b>both</b> a Branch and a Class.</div>';
    }
  }

  function toggleAll(status) {
    document.querySelectorAll('.student-checkbox').forEach(box => { box.checked = status; });
  }

  // --- SUBMIT LOGIC ---
  const form = document.getElementById('mainForm');
  const loader = document.getElementById('loader');
  const modal = document.getElementById('statusModal');
  const modalIcon = document.getElementById('modalIcon');
  const modalText = document.getElementById('modalText');
  const actionBtns = document.getElementById('postSubmitActions');

  form.addEventListener('submit', e => {
    e.preventDefault();
    handleSubmit();
  });

  // CHANGE 2: "Add Late Student" simply triggers the form submission logic
  function handleAddLate() {
      // If checkbox is checked, this button acts as "End Class"
      if (document.getElementById('closeClass').checked) {
          handleSubmit(); 
      } else {
          // If NOT checked, it acts as "Add Late Student" (Submit but keep page open)
          handleSubmit(true); 
      }
  }

  function handleSubmit(keepOpen = false) {
    loader.style.display = 'block';
    
    // Validation
    const branchInput = document.querySelector('input[name="branch"]:checked');
    if(!branchInput) { alert("Select Branch"); loader.style.display='none'; return; }

    let selectedStudents = [];
    document.querySelectorAll('.student-checkbox:checked').forEach(box => {
      selectedStudents.push({ name: box.value, phone: box.getAttribute('data-phone'), classVal: box.getAttribute('data-class') });
    });

    if (selectedStudents.length === 0) {
       let selectedRadio = document.querySelector('.class-selector:checked');
       if (!selectedRadio) { alert("Select Class"); loader.style.display='none'; return; }
       selectedStudents.push({ name: "(None/Absent)", phone: "", classVal: selectedRadio.value });
    }

    let isCloseRequested = document.getElementById('closeClass').checked;

    // Safety
    if (isCloseRequested && !currentSessionID) {
        alert("‚ö†Ô∏è Action Blocked: You cannot END a class that hasn't STARTED yet.\n\nPlease uncheck 'Close & Lock Class' and submit as an Active class first.");
        loader.style.display = 'none';
        return; 
    }

    let payload = {
      teacher: document.getElementById('teacherName').value,
      subject: document.getElementById('subject').value,
      branch: branchInput.value,
      description: document.getElementById('description').value,
      students: selectedStudents,
      close: isCloseRequested
    };

    fetch(scriptURL, { method: 'POST', body: JSON.stringify(payload) })
    .then(response => response.text()) 
    .then(text => {
      loader.style.display = 'none';
      if (text.includes("Error:")) { alert(text); return; }
      
      if (text.includes("Success")) {
        if (isCloseRequested) {
          // END CLASS LOGIC
          if (currentSessionID) removeFromQueue(currentSessionID);
          modalIcon.innerHTML = "üèÅ";
          modalText.innerText = "Class Ended!";
          modal.style.display = 'flex';
          setTimeout(() => { startNew(); }, 1500); // Reload to start new
        } else {
          // SAVE & CONTINUE LOGIC
          saveToQueue(payload);
          modalIcon.innerHTML = "‚úÖ";
          modalText.innerText = keepOpen ? "Student Added!" : "Saved & Active!";
          modal.style.display = 'flex';
          
          setTimeout(() => {
            modal.style.display = 'none';
            // IMPORTANT: Stay on same page, show action buttons
            document.getElementById('submitBtn').style.display = 'none';
            actionBtns.style.display = 'flex';
            
            // Clear checks if it was just "Add Late Student" to prepare for next late entry?
            // Actually, keep them checked so teacher sees who is present.
            // If you want to clear ONLY for "Add Late", uncomment below:
            // if(keepOpen) document.querySelectorAll('.student-checkbox').forEach(box => box.checked = false);
          }, 1000);
        }

      } else if (text.includes("CLOSED")) {
        alert("This class is already closed.");
        if(currentSessionID) removeFromQueue(currentSessionID);
        startNew();
      }
    })
    .catch(err => { console.error(err); alert("Network Error"); loader.style.display='none'; });
  }

  function startNew() {
     if (currentSessionID) { currentSessionID = null; location.reload(); } else { location.reload(); }
  }
  
  function continueUpdate(clearBoxes = true) { 
    // This function can be used if you want to manually "Reset" for adding more
    document.getElementById('postSubmitActions').style.display = 'none'; 
    document.getElementById('submitBtn').style.display = 'flex'; 
    if(clearBoxes) {
        document.querySelectorAll('.student-checkbox').forEach(box => { box.checked = false; });
    }
  }
</script>
</body>
</html>
